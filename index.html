<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Login</title>

    <link rel="icon" type="image/png" href="img/logo.png" />

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />

    <link rel="stylesheet" href="/src/web/css/styles.css" />
  </head>

  <body class="bg-light">
    <!-- Container central -->
    <div
      id="loginContainer"
      class="d-flex justify-content-center align-items-center vh-100"
    ></div>

    
    <script type="module">
      import { CongregationService } from "./src/api/services/CongregationService.js";
      import { LoginService } from "./src/api/LoginService.js";
      import { showLoading, hideLoading } from "./src/components/loading.js";
      import { showDialog } from "./src/components/dialog.js";

      const container = document.getElementById("loginContainer");
      const loginService = new LoginService(); // instância global

      async function init() {
        if (loginService.isLogged()) {
          window.location.href = "home.html";
          return;
        }

        await renderLoginForm(true);
      }

      /* Função que monta e renderiza o formulário */
      async function renderLoginForm(loading) {
        if(loading){
          showLoading(container, "STM - Loading data...");
        }
        const congregationService = new CongregationService();
        const congregations = await congregationService.get();

        container.innerHTML = `
          <div class="card p-4 shadow" style="width: 360px;">
            <div class="text-center mb-3">
              <img src="img/logo.png" alt="Logo" style="max-width:120px;">
            </div>

            <h4 class="text-center text-primary mb-4">Login</h4>

            <div class="mb-3">
              <select id="congregation" class="form-select">
                <option value="">Select a congregation</option>
                ${congregations
                  .map(c => `<option value="${c.number}">${c.name} (${c.city})</option>`)
                  .join("")}
              </select>
              <div class="invalid-feedback">Congregation is required</div>
            </div>

            <div class="mb-3">
              <input type="text" id="username" class="form-control" placeholder="Username">
              <div class="invalid-feedback">Username is required</div>
            </div>

            <div class="mb-3">
              <input type="password" id="password" class="form-control" placeholder="Password">
              <div class="invalid-feedback">Password is required</div>
            </div>

            <button id="loginBtn" class="btn btn-primary w-100">
              <i class="bi bi-box-arrow-in-right me-2"></i> Login
            </button>
          </div>
        `;

        hideLoading(); // remove overlay

        attachLoginEvent(congregations);
      }

      /* Função para anexar o evento de login */
      function attachLoginEvent(congregations) {
        document.getElementById("loginBtn").addEventListener("click", async () => {
          const congregation = document.getElementById("congregation");
          const usernameInput = document.getElementById("username");
          const passwordInput = document.getElementById("password");

          const congregationId = congregation.value;
          const username = usernameInput.value.trim();
          const password = passwordInput.value.trim();

          // Reset erros
          [congregation, usernameInput, passwordInput].forEach(el => el.classList.remove("is-invalid"));

          let valid = true;
          if (!congregationId) {
            congregation.classList.add("is-invalid");
            valid = false;
          }
          if (!username) {
            usernameInput.classList.add("is-invalid");
            valid = false;
          }
          if (!password) {
            passwordInput.classList.add("is-invalid");
            valid = false;
          }
          if (!valid) return;

          // Overlay global
          showLoading(null, "Login...");

          try {
            const user = await loginService.login(congregationId, username, password);
            hideLoading();

            if (user) {
              window.location.href = "./home.html";
            } else {
              showDialog({
                type: "ERROR",
                message: "Login failed - Invalid credentials",
              });
            }
          } catch (err) {
            hideLoading();
            showDialog({
              type: "ERROR",
              message: "An error occurred while logging in.",
            });
          }
        });
      }

      init();
      </script>


  </body>
</html>
